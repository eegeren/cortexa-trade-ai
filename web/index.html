<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Cortexa Chat Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --accent:#2563eb; --accent-2:#22c55e; --danger:#ef4444; --mono:#111827;
      --bubble-user:#dbeafe; --bubble-ai:#fff; --shadow:0 8px 24px rgba(2,6,23,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.5 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue";
      color:var(--ink); background:linear-gradient(180deg,#eef2ff 0%, #f8fafc 100%);
    }
    .wrap{max-width:980px; margin:40px auto; padding:0 16px}
    .title{
      font-size:28px; font-weight:800; letter-spacing:.2px; display:flex; align-items:center; gap:10px;
    }
    .title .logo{font-size:22px; background:#111827; color:#fff; width:36px; height:36px; border-radius:10px;
      display:grid; place-items:center}
    .toolbar-top{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:10px 0 8px;
    }
    .toolbar-top input{
      height:38px; border:1px solid #e5e7eb; border-radius:10px; padding:0 10px; background:#fff; outline:none;
    }
    .toolbar-top .btn{
      height:38px; padding:0 12px; border-radius:10px; border:0; color:#fff; background:var(--accent);
      font-weight:700; cursor:pointer;
    }
    .board{
      margin-top:10px; background:var(--card); border-radius:20px; box-shadow:var(--shadow);
      padding:18px; height:62vh; overflow:auto; scroll-behavior:smooth;
    }
    .row{display:flex; gap:12px; margin:12px 0}
    .row.user{justify-content:flex-end}
    .bubble{
      max-width:min(75%, 700px); padding:14px 16px; border-radius:14px;
      background:var(--bubble-ai); box-shadow:0 2px 10px rgba(2,6,23,.05);
      border:1px solid #e5e7eb;
    }
    .row.user .bubble{background:var(--bubble-user); border-color:#bfdbfe}
    .md :is(h1,h2,h3){margin:.6em 0 .3em}
    .md h2{font-size:18px}
    .md h3{font-size:16px}
    .md p{margin:.4em 0}
    .md strong{font-weight:700}
    .md table{border-collapse:collapse; width:100%; margin:.6em 0; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden}
    .md th,.md td{border-bottom:1px solid #e5e7eb; padding:10px 12px; text-align:left}
    .md thead th{background:#f8fafc; font-weight:800}
    .toolbar{
      margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap
    }
    input[type="text"], input[type="number"], select{
      height:44px; border:1px solid #e5e7eb; border-radius:12px; padding:0 12px; background:#fff;
      outline:none; transition:.15s; min-width: 0;
    }
    input[type="text"]{flex:1}
    input[type="text"]:focus, input[type="number"]:focus, select:focus{border-color:#93c5fd; box-shadow:0 0 0 4px rgba(59,130,246,.15)}
    .btn{
      height:44px; padding:0 18px; border-radius:12px; border:0; color:#fff; background:var(--accent);
      font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(37,99,235,.25);
    }
    .btn:disabled{opacity:.6; cursor:not-allowed; box-shadow:none}
    .switch{display:flex; align-items:center; gap:6px; font-size:14px; color:var(--muted)}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}
    .copy{
      background:#f8fafc; color:var(--mono); border:1px solid #e5e7eb; border-radius:10px; padding:6px 10px;
      font-size:13px; cursor:pointer; margin-left:auto;
    }
    .head{display:flex; align-items:center; gap:10px; margin-bottom:8px}
    .typing{opacity:.7}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title"><span class="logo">CX</span> Cortexa Chat Test</div>

    <!-- Üst çubuk: API ayarı + Health testi -->
    <div class="toolbar-top">
      <label>API:
        <input id="api" type="text" value="http://localhost:8081" style="width:280px">
      </label>
      <button id="health" class="btn">Bağlantıyı Test Et</button>
      <span id="healthStatus" class="hint"></span>
    </div>

    <div class="board" id="board"></div>

    <div class="toolbar">
      <input id="q" type="text" placeholder="Sorunuzu yazın… örn: ‘btc vs euro (6 ay, orta risk, 100k, %2 stop)’" />
      <select id="risk">
        <option value="">Risk</option>
        <option>dusuk</option><option>orta</option><option>yuksek</option>
      </select>
      <input id="horizon" type="text" placeholder="Vade (örn. 6 ay)" style="width:120px" />
      <input id="capital" type="number" placeholder="Sermaye" style="width:130px" />
      <input id="stop" type="number" step="0.001" placeholder="Stop (0.02)" style="width:110px" />
      <label class="switch"><input id="prices" type="checkbox" checked /> Fiyatları ekle</label>
      <button id="send" class="btn">Gönder</button>
    </div>
    <div class="hint">CORS açık olmalı. Backend için: <code>uvicorn src.live.advice_server:app --host 0.0.0.0 --port 8081 --reload</code></div>
  </div>

  <script>
    const elBoard  = document.getElementById("board");
    const elQ      = document.getElementById("q");
    const elSend   = document.getElementById("send");
    const elRisk   = document.getElementById("risk");
    const elHorizon= document.getElementById("horizon");
    const elCap    = document.getElementById("capital");
    const elStop   = document.getElementById("stop");
    const elPrices = document.getElementById("prices");
    const elApi    = document.getElementById("api");
    const elHealth = document.getElementById("health");
    const elHealthStatus = document.getElementById("healthStatus");

    function apiBase(){
      let base = elApi.value.trim().replace(/\/+$/,'');
      return base || "http://localhost:8081";
    }

    function addBubble({role, html, raw, typing}) {
      const row = document.createElement("div");
      row.className = "row " + (role === "user" ? "user" : "ai");

      const bubble = document.createElement("div");
      bubble.className = "bubble" + (typing ? " typing" : "");

      const head = document.createElement("div");
      head.className = "head";
      // Başlıkları kaldırmak istiyorsan bu iki satırı yoruma al:
      // const brand = document.createElement("div");
      // brand.textContent = role === "user" ? "Kullanıcı" : "Cortexa";

      // Kopyala butonu (sadece AI)
      if (role !== "user" && !typing) {
        const btn = document.createElement("button");
        btn.className = "copy";
        btn.textContent = "Kopyala";
        btn.onclick = () => {
          navigator.clipboard.writeText(raw || bubble.innerText);
          btn.textContent = "Kopyalandı ✓";
          setTimeout(()=>btn.textContent="Kopyala", 1200);
        };
        head.appendChild(btn);
      }

      bubble.appendChild(head);

      const content = document.createElement("div");
      content.className = "md";
      content.innerHTML = marked.parse(html ?? (typing ? "_yazıyor…_" : ""));
      bubble.appendChild(content);

      row.appendChild(bubble);
      elBoard.appendChild(row);
      elBoard.scrollTop = elBoard.scrollHeight;

      return { row, bubble, content };
    }

    function userTextPreview(payload){
      const parts = [];
      if (payload.horizon) parts.push(`Vade: ${payload.horizon}`);
      if (payload.risk) parts.push(`Risk: ${payload.risk}`);
      if (payload.capital) parts.push(`Sermaye: ${Number(payload.capital).toLocaleString("tr-TR")}`);
      if (payload.stop_pct) parts.push(`Stop: ${payload.stop_pct}`);
      return parts.length ? " — " + parts.join(" | ") : "";
    }

    async function ask() {
      const user_query = elQ.value.trim();
      if (!user_query) return;

      const payload = {
        user_query,
        horizon: elHorizon.value.trim(),
        risk: elRisk.value.trim(),
        capital: elCap.value ? Number(elCap.value) : null,
        stop_pct: elStop.value ? Number(elStop.value) : null,
        show_prices: elPrices.checked,
        // Kullanım koşullarını kabul ettiysen uyarıyı bastır (frontend tarafında)
        suppress_disclaimer: true
      };

      addBubble({ role:"user", html: marked.parseInline(user_query + userTextPreview(payload)) });

      elSend.disabled = true;
      const typing = addBubble({ role:"ai", html: "_yazıyor…_", typing: true });

      try {
        const res = await fetch(apiBase() + "/advice", {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload),
        });

        typing.bubble.classList.remove("typing");

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || `HTTP ${res.status}`);
        }

        const data = await res.json();
        const answer = data.answer || "Veri yok";
        typing.content.innerHTML = marked.parse(answer);

      } catch (err) {
        typing.content.innerHTML = marked.parse(`**Hata:** ${String(err.message || err)}\n\nSunucu çalışıyor mu? \`${apiBase()}/health\` → **ok:true**`);
      } finally {
        elSend.disabled = false;
        elQ.value = "";
        elQ.focus();
      }
    }

    elSend.addEventListener("click", ask);
    elQ.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); ask(); } });

    // Health testi
    elHealth.addEventListener("click", async ()=>{
      elHealthStatus.textContent = "Test ediliyor…";
      try {
        const r = await fetch(apiBase() + "/health");
        const j = await r.json();
        elHealthStatus.textContent = j.ok ? "Bağlantı OK ✅" : "Bağlantı başarısız ❌";
      } catch {
        elHealthStatus.textContent = "Bağlantı başarısız ❌";
      }
    });

    // İlk odak
    elQ.focus();
  </script>
</body>
</html>