<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Cortexa Advisor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --accent:#2563eb; --accent-2:#22c55e; --danger:#ef4444; --mono:#111827;
      --bubble-user:#e8f0ff; --bubble-ai:#fff; --shadow:0 10px 30px rgba(2,6,23,.08);
      --radius:16px; --chip:#eef2ff; --chip-ink:#1e293b; --badge:#f1f5f9;
      --ctrl-bg:#f8fafc; --ctrl-brd:rgba(100,116,139,.22);
    }
    [data-theme="dark"]{
      --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
      --accent:#3b82f6; --accent-2:#22c55e; --danger:#ef4444; --mono:#e5e7eb;
      --bubble-user:#102139; --bubble-ai:#0c1426; --chip:#0b1a33; --chip-ink:#cbd5e1; --badge:#0b1a33;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --ctrl-bg:#0d1a2f; --ctrl-brd:rgba(148,163,184,.18);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.55 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue";
      color:var(--ink); background:linear-gradient(180deg,rgba(59,130,246,.06) 0%, var(--bg) 150px);
    }
    /* ===== Topbar ===== */
    .topbar{
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(6px);
      background:linear-gradient(180deg,rgba(255,255,255,.7),rgba(255,255,255,0));
      border-bottom:1px solid rgba(100,116,139,.15);
    }
    [data-theme="dark"] .topbar{ background:linear-gradient(180deg,rgba(2,6,23,.55),rgba(2,6,23,0)); border-color:rgba(148,163,184,.15); }
    .bar-wrap{max-width:1100px; margin:0 auto; padding:14px 16px; display:flex; align-items:center; gap:12px; }
    .brand{
      display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.2px;
    }
    .logo-badge{width:36px; height:36px; border-radius:10px; background:#111827; color:#fff; display:grid; place-items:center; font-weight:900}
    [data-theme="dark"] .logo-badge{background:#0b1220; border:1px solid #1f2937}
    .brand .name{font-size:18px}
    .spacer{flex:1}
    .icon-btn{height:38px; padding:0 12px; border-radius:10px; border:1px solid rgba(100,116,139,.25); background:transparent; color:var(--ink); cursor:pointer}
    .icon-btn:active{transform:translateY(1px)}
    /* ===== Layout ===== */
    .wrap{max-width:1100px; margin:20px auto 28px; padding:0 16px}
    .hero{
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:10px;
    }
    .hero-title{font-size:24px; font-weight:800; letter-spacing:.2px}
    .hero-sub{color:var(--muted); font-size:14px}
    .board{
      margin-top:8px; background:var(--card); border-radius:20px; box-shadow:var(--shadow);
      padding:18px; height:62vh; overflow:auto; scroll-behavior:smooth;
    }
    /* ===== Bubbles ===== */
    .row{display:flex; gap:12px; margin:12px 0}
    .row.user{justify-content:flex-end}
    .bubble{
      position:relative;
      max-width:min(78%, 760px); padding:14px 16px; border-radius:14px;
      background:var(--bubble-ai); box-shadow:0 2px 10px rgba(2,6,23,.05);
      border:1px solid rgba(100,116,139,.2);
    }
    .row.user .bubble{background:var(--bubble-user); border-color:rgba(59,130,246,.35)}
    /* baÅŸlÄ±klar gizli â€” sade gÃ¶rÃ¼nÃ¼m */
    .head{display:none}
    .copy{
      position:absolute; top:8px; right:8px;
      background:transparent; border:1px solid rgba(100,116,139,.25); color:var(--ink);
      padding:6px 10px; border-radius:10px; cursor:pointer; font-size:13px
    }
    .md :is(h1,h2,h3){margin:.6em 0 .35em}
    .md h2{font-size:18px}
    .md h3{font-size:16px}
    .md p{margin:.45em 0}
    .md strong{font-weight:700}
    .md table{border-collapse:collapse; width:100%; margin:.6em 0; border:1px solid rgba(100,116,139,.25); border-radius:10px; overflow:hidden}
    .md th,.md td{border-bottom:1px solid rgba(100,116,139,.25); padding:10px 12px; text-align:left}
    .md thead th{background:var(--badge); font-weight:800}
    .md code{background:#0f172a; color:#fff; padding:.15em .4em; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas; font-size:90%}
    /* ===== Chips ===== */
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0}
    .chip{padding:6px 10px; border-radius:999px; background:var(--chip); color:var(--chip-ink); border:1px solid rgba(100,116,139,.25); cursor:pointer; font-size:13px}
    /* ===== Controls ===== */
    .controlbar{
      display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;
      background:var(--ctrl-bg); border:1px solid var(--ctrl-brd);
      padding:12px; border-radius:14px; margin-top:12px;
    }
    .ctrl{display:flex; flex-direction:column; gap:6px; min-width:140px}
    .ctrl.small{min-width:110px}
    .ctrl .lbl{font-size:12px; color:var(--muted); font-weight:600; letter-spacing:.2px}
    .ctrl input, .ctrl select, .ctrl textarea{
      height:40px; border:1px solid var(--ctrl-brd); border-radius:10px; padding:0 10px; background:transparent; color:var(--ink); outline:none;
    }
    .ctrl textarea{height:auto; min-height:40px; padding:8px 10px; resize:vertical}
    .ctrl input:focus, .ctrl select:focus, .ctrl textarea:focus{ border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15) }
    .ctrl .switch{
      height:40px; display:flex; align-items:center; gap:8px; padding:0 10px;
      border:1px solid var(--ctrl-brd); border-radius:10px; color:var(--muted);
    }
    .ctrl .switch input{margin:0}
    .send-wrap{margin-left:auto; display:flex; align-items:end}
    .btn{height:44px; padding:0 18px; border-radius:12px; border:0; color:#fff; background:var(--accent);
      font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(37,99,235,.25);}
    .btn:disabled{opacity:.6; cursor:not-allowed; box-shadow:none}
    .filters{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px}
    .filters .pill{background:var(--badge); padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(100,116,139,.25)}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}
    .settings{margin-top:8px; font-size:12px; color:var(--muted)}
    .settings input{height:36px}
    /* ===== Modal ===== */
    .modal { position:fixed; inset:0; display:none; place-items:center; background:rgba(15,23,42,.55); z-index:50; }
    .modal.show { display:grid; }
    .modal-card{
      width:min(560px, 92%); background:var(--card); border-radius:16px; box-shadow:0 20px 60px rgba(2,6,23,.35);
      padding:22px; border:1px solid rgba(100,116,139,.25);
    }
    .modal-card h3{margin:0 0 8px; font-size:18px}
    .modal-card p{color:var(--muted); margin:6px 0}
    .modal-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:14px}
    .btn-ghost{height:42px; padding:0 14px; border-radius:12px; border:1px solid rgba(100,116,139,.25); background:transparent; color:var(--ink); cursor:pointer}
    /* ===== Typing & Toast ===== */
    .typing{position:relative; overflow:hidden}
    .typing:after{content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent, rgba(148,163,184,.15), transparent); animation:sh 1.2s infinite}
    @keyframes sh{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
    .toast{position:fixed; right:16px; bottom:16px; background:var(--card); color:var(--ink); border:1px solid rgba(100,116,139,.25); padding:10px 14px; border-radius:10px; box-shadow:var(--shadow); opacity:0; transform:translateY(10px); transition:.2s; z-index:60}
    .toast.show{opacity:1; transform:translateY(0)}
    /* ===== Responsive ===== */
    @media (max-width:720px){
      .ctrl{min-width:120px}
      .ctrl.small{min-width:100px}
      .send-wrap{width:100%}
      .btn{width:100%}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="bar-wrap">
      <div class="brand">
        <div class="logo-badge">CX</div>
        <div>
          <div class="name">Cortexa Advisor</div>
          <div class="hero-sub">Finansal iÃ§gÃ¶rÃ¼ ve planlama asistanÄ±</div>
        </div>
      </div>
      <div class="spacer"></div>
      <button class="icon-btn" id="themeBtn">ðŸŒ— Tema</button>
    </div>
  </div>

  <div class="wrap">
    <div class="hero">
      <div class="hero-title">Sohbet</div>
      <div class="hero-sub">Net, kÄ±sa ve uygulanabilir yanÄ±tlar</div>
    </div>

    <div class="board" id="board"></div>

    <div class="chips" id="examples">
      <div class="chip" data-q="btc vs euro (6 ay, orta risk, 100k, %2 stop)">BTC vs EUR (Ã¶r.)</div>
      <div class="chip" data-q="altÄ±n almalÄ± mÄ±yÄ±m? (12 ay, dÃ¼ÅŸÃ¼k risk)">AltÄ±n almalÄ± mÄ±yÄ±m?</div>
      <div class="chip" data-q="Apple mÄ± Tesla mÄ±? (orta risk, 6 ay, 50k)">Apple vs Tesla</div>
      <div class="chip" data-q="portfÃ¶yÃ¼mÃ¼ nasÄ±l daÄŸÄ±tmalÄ±yÄ±m? (uzun vade, orta risk)">PortfÃ¶y daÄŸÄ±lÄ±mÄ±</div>
      <div class="chip" data-q="btc kaldÄ±raÃ§lÄ± Ã¶ner (orta risk, 50k, %1.5 stop)">BTC kaldÄ±raÃ§lÄ± Ã¶ner</div>
    </div>

    <div class="filters" id="filterChips" style="display:none;"></div>

    <div class="controlbar">
      <div class="ctrl" style="flex:1 1 420px">
        <div class="lbl">Soru</div>
        <textarea id="q" rows="1" placeholder="Ã–rn: btc vs euro (6 ay, orta risk, 100k, %2 stop)"></textarea>
      </div>
      <div class="ctrl small">
        <div class="lbl">Risk</div>
        <select id="risk">
          <option value="">SeÃ§</option>
          <option>dusuk</option><option>orta</option><option>yuksek</option>
        </select>
      </div>
      <div class="ctrl small">
        <div class="lbl">Vade</div>
        <input id="horizon" type="text" placeholder="Ã¶rn. 6 ay" />
      </div>
      <div class="ctrl small">
        <div class="lbl">Sermaye</div>
        <input id="capital" type="number" placeholder="Ã¶rn. 100000" />
      </div>
      <div class="ctrl small">
        <div class="lbl">Stop</div>
        <input id="stop" type="number" step="0.001" placeholder="0.02" />
      </div>
      <div class="ctrl small">
        <div class="lbl">Fiyatlar</div>
        <label class="switch"><input id="prices" type="checkbox" checked /> Ekle</label>
      </div>
      <div class="send-wrap">
        <button id="send" class="btn">GÃ¶nder</button>
      </div>
    </div>

    <div class="settings">
      API: <input id="api" type="text" style="width:320px" />
      <button id="saveApi" class="icon-btn">Kaydet</button>
      <span class="hint">CORS aÃ§Ä±k olmalÄ± â€¢ <code>/health</code> â†’ ok:true</span>
    </div>
  </div>

  <!-- Terms Modal -->
  <div id="termsModal" class="modal">
    <div class="modal-card">
      <h3>KullanÄ±m KoÅŸullarÄ±</h3>
      <p>Bu platform eÄŸitim ve genel bilgilendirme amaÃ§lÄ±dÄ±r. Ä°ÅŸlem kararlarÄ± size aittir.</p>
      <label style="display:flex;align-items:center;gap:8px;margin-top:10px">
        <input type="checkbox" id="termsChk" />
        <span>KoÅŸullarÄ± okudum ve kabul ediyorum.</span>
      </label>
      <div class="modal-actions">
        <button id="termsCancel" class="btn-ghost">VazgeÃ§</button>
        <button id="termsAccept" class="btn">Devam et</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    /* ====== STATE & UTIL ====== */
    const DEFAULT_API = "http://localhost:8081/advice";
    const API_KEY = "cx_api";
    const TERMS_KEY = "cx_terms_ok";
    const THEME_KEY = "cx_theme";

    const elBoard  = document.getElementById("board");
    const elQ      = document.getElementById("q");
    const elSend   = document.getElementById("send");
    const elRisk   = document.getElementById("risk");
    const elHorizon= document.getElementById("horizon");
    const elCap    = document.getElementById("capital");
    const elStop   = document.getElementById("stop");
    const elPrices = document.getElementById("prices");
    const elApi    = document.getElementById("api");
    const elSaveApi= document.getElementById("saveApi");
    const examples = document.getElementById("examples");
    const filterChips = document.getElementById("filterChips");
    const toast   = document.getElementById("toast");

    /* Theme */
    const themeBtn = document.getElementById("themeBtn");
    const setTheme = (t)=>{ document.documentElement.setAttribute("data-theme", t); localStorage.setItem(THEME_KEY, t); };
    setTheme(localStorage.getItem(THEME_KEY) || "light");
    themeBtn.onclick = ()=> setTheme(document.documentElement.getAttribute("data-theme")==="light"?"dark":"light");

    /* API config */
    elApi.value = localStorage.getItem(API_KEY) || DEFAULT_API;
    function API(){ return localStorage.getItem(API_KEY) || DEFAULT_API; }
    elSaveApi.onclick = ()=>{ localStorage.setItem(API_KEY, elApi.value.trim() || DEFAULT_API); ping("API kaydedildi"); };

    /* Toast */
    function ping(msg){ toast.textContent = msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"),1500); }

    /* Terms */
    const modal   = document.getElementById("termsModal");
    const chk     = document.getElementById("termsChk");
    const btnOk   = document.getElementById("termsAccept");
    const btnNo   = document.getElementById("termsCancel");
    function lockUI(lock){ [elQ, elSend, elRisk, elHorizon, elCap, elStop, elPrices].forEach(x=> x.disabled = lock); }
    function openTerms(){ modal.classList.add("show"); lockUI(true); }
    function closeTerms(){ modal.classList.remove("show"); lockUI(false); elQ.focus(); }
    btnOk.onclick = () => { if(!chk.checked) { ping("LÃ¼tfen koÅŸullarÄ± onaylayÄ±n"); return; } localStorage.setItem(TERMS_KEY, "1"); closeTerms(); };
    btnNo.onclick = () => { window.location.href = "about:blank"; };
    if(localStorage.getItem(TERMS_KEY) !== "1"){ openTerms(); } else { closeTerms(); }

    /* Examples */
    examples.addEventListener("click", (e)=>{
      const chip = e.target.closest(".chip"); if(!chip) return;
      elQ.value = chip.dataset.q || ""; autoRows(); elQ.focus();
    });

    /* Filter chips */
    function refreshFilterChips(){
      const parts = [];
      if (elHorizon.value) parts.push(["Vade", elHorizon.value]);
      if (elRisk.value)    parts.push(["Risk", elRisk.value]);
      if (elCap.value)     parts.push(["Sermaye", Number(elCap.value).toLocaleString("tr-TR")]);
      if (elStop.value)    parts.push(["Stop", elStop.value]);
      filterChips.innerHTML = parts.map(p=>`<div class="pill"><strong>${p[0]}:</strong> ${p[1]}</div>`).join("");
      filterChips.style.display = parts.length ? "flex" : "none";
    }
    ["input","change"].forEach(ev=>{
      [elHorizon, elRisk, elCap, elStop].forEach(el=> el.addEventListener(ev, refreshFilterChips));
    });

    /* Autosize textarea */
    function autoRows(){ elQ.style.height = "auto"; elQ.style.height = Math.min(elQ.scrollHeight, 220) + "px"; }
    elQ.addEventListener("input", autoRows); autoRows();

    /* Chat bubbles */
    function addBubble({role, html, raw, typing}) {
      const row = document.createElement("div");
      row.className = "row " + (role === "user" ? "user" : "ai");

      const bubble = document.createElement("div");
      bubble.className = "bubble" + (typing ? " typing" : "");

      const head = document.createElement("div");
      head.className = "head"; // gizli
      bubble.appendChild(head);

      const content = document.createElement("div");
      content.className = "md";
      content.innerHTML = marked.parse(html ?? (typing ? " " : ""));
      bubble.appendChild(content);

      if (role !== "user" && !typing) {
        const btn = document.createElement("button");
        btn.className = "copy";
        btn.textContent = "Kopyala";
        btn.onclick = () => { navigator.clipboard.writeText(raw || bubble.innerText); ping("KopyalandÄ± âœ“"); };
        bubble.appendChild(btn);
      }

      row.appendChild(bubble);
      elBoard.appendChild(row);
      elBoard.scrollTop = elBoard.scrollHeight;

      return { row, bubble, content };
    }

    function userTextPreview(payload){
      const parts = [];
      if (payload.horizon) parts.push(`Vade: ${payload.horizon}`);
      if (payload.risk) parts.push(`Risk: ${payload.risk}`);
      if (payload.capital) parts.push(`Sermaye: ${Number(payload.capital).toLocaleString("tr-TR")}`);
      if (payload.stop_pct) parts.push(`Stop: ${payload.stop_pct}`);
      return parts.length ? " â€” " + parts.join(" | ") : "";
    }

    async function ask() {
      const user_query = elQ.value.trim();
      if (!user_query) return;

      const payload = {
        user_query,
        horizon: elHorizon.value.trim(),
        risk: elRisk.value.trim(),
        capital: elCap.value ? Number(elCap.value) : null,
        stop_pct: elStop.value ? Number(elStop.value) : null,
        show_prices: elPrices.checked,
        suppress_disclaimer: (localStorage.getItem(TERMS_KEY) === "1")
      };

      addBubble({ role:"user", html: user_query + (userTextPreview(payload) ? "\n\n" + userTextPreview(payload) : "") });

      elSend.disabled = true;
      const typing = addBubble({ role:"ai", html: "_yazÄ±yorâ€¦_", typing: true });

      try {
        const res = await fetch(API(), {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload),
        });

        typing.bubble.classList.remove("typing");

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || `HTTP ${res.status}`);
        }

        const data = await res.json();
        const answer = data.answer || "Veri yok";
        typing.content.innerHTML = marked.parse(answer);

      } catch (err) {
        typing.content.innerHTML = marked.parse(`**Hata:** ${String(err.message || err)}\n\nSunucu Ã§alÄ±ÅŸÄ±yor mu? \`/health\` â†’ **ok:true**`);
      } finally {
        elSend.disabled = false;
        elQ.value = "";
        autoRows();
        refreshFilterChips();
        elQ.focus();
      }
    }

    document.getElementById("send").addEventListener("click", ask);
    elQ.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); ask(); } });

    // Ä°lk odak
    elQ.focus();
    refreshFilterChips();
  </script>
</body>
</html>